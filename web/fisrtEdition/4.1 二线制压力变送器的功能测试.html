<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>å·¥ä¸šå®éªŒå®¤ - å…¨å¯åŠ¨ç²¾æ§ç‰ˆ</title>
    <style>
        :root {
            --bg: #2c3e50;
            --panel: #f7f9fb;
            --wire: #ff4757;
            --pipe: #3498db;
            --lcd-bg: #1e272e;
            --lcd-text: #0be881;
        }

        body {
            font-family: 'Segoe UI', system-ui;
            background: var(--panel);
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .workbench {
            background: var(--panel);
            width: 1500px;
            height: 850px;
            position: relative;
            border: 5px solid var(--bg);
            border-radius: 6px;
            background-image:
                radial-gradient(rgba(0, 0, 0, .15) 1px, transparent 1px);
            background-size: 60px 60px;
            box-shadow:
                0 20px 40px rgba(0, 0, 0, .4),
                inset 0 1px 3px rgba(255, 255, 255, .5);
        }

        #topInfo {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 700px;
            background: rgba(45, 52, 54, 0.95);
            border-bottom: 4px solid #f1c40f;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            z-index: 3000;
            text-align: center;
            font-size: 16px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);

        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 1000;
        }

        /* é€šç”¨ç»„ä»¶æ ·å¼ */
        .comp,
        .ui-draggable {
            position: absolute;
            border: 2px solid #2d3436;
            border-radius: 6px;
            z-index: 10;
            cursor: move;
            box-shadow: 2px 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            background: #fff;
        }

        .label,
        .ui-header {
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            background: rgba(45, 52, 54, 0.9);
            color: white;
            padding: 6px;
            pointer-events: none;
            border-radius: 4px 4px 0 0;
        }

        /* æ§åˆ¶å°ç‰¹æœ‰æ ·å¼ */
        .ui-draggable {
            width: 220px;
            background: rgba(45, 52, 54, 0.98);
            color: white;
            z-index: 2000;
            border: 1px solid #636e72;
        }

        .ui-header {
            background: #1e272e;
            color: #f1c40f;
            pointer-events: auto;
            cursor: move;
        }

        .ui-body {
            padding: 15px;
            pointer-events: auto;
        }

        /* æ¥çº¿æŸ± */
        .term {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            position: absolute;
            border: 2px solid #333;
            z-index: 100;
            transform: translate(-50%, 50%);
            cursor: pointer;
        }

        .term-p {
            background: #ff4757;
        }

        .term-n {
            background: #2f3542;
        }

        .term-gas {
            width: 20px;
            height: 20px;
            border-radius: 20%;
            background: #95a5a6;
            border: 2px solid #333;
        }

        .term.active {
            outline: 4px solid #f1c40f;
            box-shadow: 0 0 15px #f1c40f;
        }

        /* ä»ªè¡¨ */
        .gauge-face {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            border: 3px solid #333;
            /*--ï¼å†…åœ†åŠå¾„62ï¼Œå¤–åœ†65--*/
            position: relative;
            background: #eae7e7;
            margin: 5px;
            align-self: center;
            /*--!ç›¸å¯¹äºçˆ¶å®¹å™¨ï¼Œæ°´å¹³å‚ç›´éƒ½å±…ä¸­--*/
        }

        .tick {
            position: absolute;
            background: #333;
            left: 50%;
            bottom: 50%;
            transform-origin: bottom center;
        }

        .tick-major {
            width: 2px;
            height: 10px;
        }

        .tick-minor {
            width: 1px;
            height: 5px;
        }

        .tick-text {
            position: absolute;
            font-size: 9px;
            font-weight: bold;
            color: #333;
            width: 30px;
            text-align: center;
            transform: translate(-50%, -50%);
        }

        .needle {
            width: 2px;
            height: 55px;
            background: #e74c3c;

            position: absolute;
            bottom: 50%;
            left: 50%;
            transform-origin: bottom center;
            transition: 0.4s;
            z-index: 5;
        }

        .lcd {
            background: var(--lcd-bg);
            color: var(--lcd-text);
            font-family: monospace;
            font-size: 18px;
            text-align: center;
            width: 85px;

            margin: 5px auto;
            padding: 4px 10px;
            border-radius: 3px;
            border: 1px solid #444;
        }

        .btn {
            width: 100%;
            align-self: center;
            padding: 10px;
            margin-top: 8px;

            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            color: white;
            font-size: 14px;
        }

        input[type="range"] {
            cursor: pointer;
            height: 20px;
            width: 90%;
            align-self: center;
        }
    </style>
</head>

<body>

    <div class="workbench" id="bench">
        <div id="topInfo" class="ui-draggable">æ¨¡å¼ï¼šå…¨è‡ªç”±äº¤äº’ã€‚æ‹–åŠ¨æ ‡é¢˜æ å¯ç§»åŠ¨æ§åˆ¶å°ã€‚</div>

        <div id="uiBox" class="ui-draggable" style="left:50px; top:40px;">
            <div class="ui-header">âš“ æ§åˆ¶å° (å¯æ‹–åŠ¨)</div>
            <div class="ui-body">
                <button class="btn" style="background:#0984e3;" onclick="nextWireStep()">ğŸ”Œ æ¼”ç¤ºè¿çº¿</button>
                <button class="btn" style="background:#e67e22;" onclick="undo()">â†©ï¸ æ’¤é”€ä¸€æ­¥</button>
                <button class="btn" style="background:#8e44ad;" onclick="manualFivePoint()">ğŸ“Š æ‰‹åŠ¨5ç‚¹æ­¥è¿›</button>
                <button class="btn" style="background:#d63031;" onclick="location.reload()">ğŸ”„ é‡ç½®å®éªŒ</button>
            </div>
        </div>

        <canvas id="canvas" width="1200" height="850"></canvas>

        <div id="c_pwr" class="comp" style="width:110px; height:130px; left:40px; top:390px;">
            <div class="label">24V DC POWER</div>
            <div id="t_p_p" class="term term-p" style="left:100%; top:35px;" data-type="wire"></div>
            <div id="t_p_n" class="term term-n" style="left:100%; top:85px;" data-type="wire"></div>
        </div>

        <div id="c_sw" class="comp" style="width:100px; height:100px; left:240px; top:350px;">
            <div class="label">å›è·¯æ€»é—¸</div>
            <div id="blade"
                style="position:absolute; width:90px; height:10px; background:#e74c3c; left:3px; top:52px; transform-origin:left bottom; transition:0.3s; transform:rotate(-20deg); cursor:pointer;"
                onclick="toggleSw()"></div>
            <div id="t_s_i" class="term term-n" style="left:0%; top:40px;" data-type="wire"></div>
            <div id="t_s_o" class="term term-n" style="left:100%; top:40px;" data-type="wire"></div>
        </div>

        <div id="c_tr" class="comp" style="width:200px; height:180px; left:480px; top:240px;">
            <div class="label">å˜é€å™¨ç²¾è°ƒ (ZERO/SPAN)</div>
            <div style="padding:15px; display:flex; flex-direction:column; gap:10px;">
                <input type="range" id="zS" min="-2" max="2" step="0.01" value="0" oninput="update()">
                <input type="range" id="sS" min="0.8" max="1.2" step="0.01" value="1" oninput="update()">
            </div>
            <div id="t_t_p" class="term term-p" style="left:0%; top:50px;" data-type="wire"></div>
            <div id="t_t_n" class="term term-n" style="left:100%; top:50px;" data-type="wire"></div>
            <div id="t_t_g" class="term term-gas" style="left:50%; top:86%;" data-type="pipe"></div>
        </div>

        <div id="c_reg" class="comp" style="width:180px; height:160px; left:820px; top:450px;">
            <div class="label">ç²¾å¯†å‹åŠ›è°ƒèŠ‚é˜€</div>
            <div id="pValDisp"
                style="font-size:24px; font-weight:bold; color:#2980b9; text-align:center; padding:10px;">0.00</div>
            <div style="padding:10px; border-top:1px solid #ddd; display:flex; justify-content:center;">
                <input type="range" id="pS" min="0" max="1" step="0.01" value="0" oninput="update()">
            </div>
            <div id="t_r_i" class="term term-gas" style="left:100%; top:45%;" data-type="pipe"></div>
            <div id="t_r_o" class="term term-gas" style="left:0%; top:45%;" data-type="pipe"></div>
        </div>

        <div id="c_am" class="comp" style="width:160px; height:240px; left:420px; top:560px;">
            <div class="label">ç”µæµæµ‹é‡ (mA)</div>
            <div class="lcd" id="aLcd">0.00</div>
            <div class="gauge-face" id="f_am">
                <div id="aNeedle" class="needle"></div>
            </div>
            <div id="t_a_n" class="term term-n" style="left:0%; top:210px;" data-type="wire"></div>
            <div id="t_a_p" class="term term-p" style="left:100%; top:210px;" data-type="wire"></div>
        </div>

        <div id="c_pg" class="comp" style="width:160px; height:240px; left:730px; top:120px;">
            <div class="label">æ ‡å‡†å‹åŠ› (MPa)</div>
            <div class="lcd" id="pLcd">0.00</div>
            <div class="gauge-face" id="f_pg">
                <div id="pNeedle" class="needle"></div>
            </div>
            <div id="t_g_i" class="term term-gas" style="left:50%; top:90%;" data-type="pipe"></div>
        </div>

        <div id="c_gas" class="comp"
            style="width:90px; height:240px; left:1080px; top:400px; background:#ecf0f1; border:none;">
            <div class="label" style="background:#333;">å‹ç¼©ç©ºæ°”ç“¶</div>
            <div id="vHandle"
                style="position:absolute; width:45px; height:12px; background:#ff4757; left:10px; top:140px; border-radius:6px; cursor:pointer; transform-origin:right center;"
                onclick="toggleV()"></div>
            <div id="t_gas" class="term term-gas" style="left:0%; top:120px;" data-type="pipe"></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
        let conns = [], vOn = false, swOn = false, wireIdx = 0, selectedTerm = null, history = [];

        // --- ç»˜å›¾å‡½æ•° ---
        function drawDetailedGauge(id, max) {
            const face = document.getElementById(id);
            for (let i = 0; i <= 50; i++) {   //æ€»å…±50ä¸ªåˆ»åº¦ã€‚
                const angle = -120 + (i / 50) * 240;  //ä»-120åº¦å¼€å§‹ï¼Œåˆ°æ­£120åº¦
                const tick = document.createElement('div');  //æ¯ä¸ªåˆ»åº¦éƒ½æ˜¯ä¸€ä¸ª divå…ƒç´ 
                tick.className = i % 5 === 0 ? 'tick tick-major' : 'tick tick-minor';  //æ¯éš”5ä¸ªæ˜¯ä¸»å…ƒç´ 
                tick.style.transform = `translateX(-50%) rotate(${angle}deg) translateY(-60px)`;  //ç›¸å¯¹äºåœ†ä¸­å¿ƒï¼Œå…ˆæ°´å¹³å±…ä¸­ï¼Œæ—‹è½¬ï¼Œå†åœ¨Yè½´æ–¹å‘å‘ä¸Šç§»åŠ¨60pxï¼Œç”¨äºåˆ»åº¦ã€‚
                face.appendChild(tick);
                if (i % 5 === 0) {
                    const val = (i / 50) * max;
                    const txt = document.createElement('div');
                    txt.className = 'tick-text';
                    const rad = (angle - 90) * (Math.PI / 180);  //HTMLæ˜¯ä»¥å‚ç›´å‘ä¸Šä¸º0åº¦ï¼Œå®é™…è¯¥è§’åº¦ä¸º-90åº¦ã€‚
                    txt.style.left = (65 + 48 * Math.cos(rad)) + 'px';
                    txt.style.top = (65 + 48 * Math.sin(rad)) + 'px';
                    txt.innerText = val.toFixed(val === 0 || val === max ? 0 : 1);
                    face.appendChild(txt);
                }
            }
        }

        // --- æ’¤é”€ç®¡ç† ---
        function pushHistory(type, data) { history.push({ type, data }); }  //æ²¡åšä¸€æ­¥æœ‰æ•ˆæ“ä½œï¼Œéƒ½å­˜å‚¨åœ¨å†å²é‡Œé¢ã€‚
        function undo() {
            if (!history.length) return;
            const last = history.pop();  //ä»å†å²ä¸­å¼¹å‡ºä¸€ä¸ªæ“ä½œï¼Œæ’¤é”€è¯¥æ“ä½œã€‚
            if (last.type === 'conn') { conns.pop(); if (wireIdx > 0) wireIdx--; }
            else if (last.type === 'sw') swOn = last.data;
            else if (last.type === 'valve') vOn = last.data;
            update();  //è¿›è¡Œåˆ·æ–°ã€‚
        }

        // --- æ ¸å¿ƒäº¤äº’ ---
        function toggleSw() { pushHistory('sw', swOn); swOn = !swOn; update(); }  //æœ‰æ•ˆæ“ä½œã€‚ä¿å­˜-åšäº‹-åˆ·æ–°ã€‚
        function toggleV() { pushHistory('valve', vOn); vOn = !vOn; update(); }

        document.querySelectorAll('.term').forEach(t => {  //ç‚¹å‡»æ¥çº¿ç«¯æ—¶çš„æ“ä½œã€‚é€‰ä¸­ã€æ¿€æ´»----å–æ¶ˆé€‰ä¸­----ç”Ÿæˆè¿çº¿ï¼ˆä¿å­˜---åšäº‹---åˆ·æ–°ï¼‰
            t.onclick = (e) => {
                e.stopPropagation();
                if (!selectedTerm) { selectedTerm = t; t.classList.add('active'); }
                else {
                    if (selectedTerm !== t && selectedTerm.dataset.type === t.dataset.type) {
                        conns.push({ from: selectedTerm.id, to: t.id, type: t.dataset.type });
                        pushHistory('conn', null);
                    }
                    selectedTerm.classList.remove('active'); selectedTerm = null; update();
                }
            };
        });

        // é”®ç›˜ç²¾æ§ï¼šå¹…åº¦0.01
        document.addEventListener('keydown', (e) => {
            if (e.target.type === 'range') {
                if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                    e.preventDefault();
                    const step = 0.01;
                    const cur = parseFloat(e.target.value);
                    e.target.value = (e.key === 'ArrowRight' ? cur + step : cur - step).toFixed(2);
                    update();
                }
            }
        });

        function update() {
            const setP = parseFloat(document.getElementById('pS').value);  //å–å¾—å‹åŠ›è®¾å®šæ•°æ®
            const z = parseFloat(document.getElementById('zS').value), s = parseFloat(document.getElementById('sS').value);  //å–å¾—é›¶ç‚¹å’Œé‡ç¨‹æ•°æ®
            const p = vOn ? setP : 0;  //å–å¾—æˆªæ­¢é˜€çŠ¶æ€å’Œè®¾å®šå‹åŠ›
            document.getElementById('blade').style.transform = swOn ? "rotate(0deg)" : "rotate(-15deg)";  //æ ¹æ®å¼€å…³çŠ¶æ€è®¾å®š  æ˜¾ç¤ºçŠ¶æ€ã€‚
            document.getElementById('vHandle').style.transform = vOn ? "rotate(0deg)" : "rotate(90deg)";   //æ ¹æ®æˆªæ­¢é˜€çŠ¶æ€è®¾å®šæ˜¾ç¤ºã€‚
            document.getElementById('pValDisp').innerText = p.toFixed(2);  //æ ¹æ®å‹åŠ›è®¾å®š å‹åŠ›æ˜¾ç¤ºæ¶²æ™¶ã€‚

            const isC = (a, b) => conns.some(c => (c.from === a && c.to === b) || (c.from === b && c.to === a));  //å®šä¹‰è¿æ¥æ£€æµ‹å‡½æ•°ã€‚
            const elec = isC('t_p_p', 't_s_i') && swOn && isC('t_s_o', 't_t_p') && isC('t_t_n', 't_a_p') && isC('t_a_n', 't_p_n');  //åˆ¤æ–­ç”µè·¯è¿æ¥çŠ¶æ€
            const pTr = (isC('t_gas', 't_r_i') && isC('t_r_o', 't_t_g')) ? p : 0;  //å‹åŠ›å˜é€å™¨çš„è¾“å…¥å‹åŠ›è®¡ç®—ï¼Œ
            const pGa = (isC('t_gas', 't_r_i') && isC('t_r_o', 't_g_i')) ? p : 0;  //å‹åŠ›è¡¨çš„è¾“å…¥å€¼
            const cur = elec ? (pTr * 16 * s + 4 + z) : 0;  //ç”µæµè¡¨çš„å‹åŠ›è®¡ç®—ã€‚

            document.getElementById('aLcd').innerText = cur.toFixed(2);  //ç”µæµè¡¨æ˜¾ç¤º
            document.getElementById('pLcd').innerText = pGa.toFixed(2);  //å‹åŠ›è¡¨æ˜¾ç¤º
            document.getElementById('aNeedle').style.transform = `rotate(${(Math.min(cur, 22) / 20 * 240 - 120)}deg)`;   //ç”µæµè¡¨æŒ‡é’ˆçš„æ—‹è½¬ã€‚
            document.getElementById('pNeedle').style.transform = `rotate(${(pGa * 240 - 120)}deg)`;  //å‹åŠ›è¡¨æŒ‡é’ˆçš„æ—‹è½¬
            renderWires(elec, isC('t_gas', 't_r_i') && vOn);    //åˆ·æ–°è¿çº¿çš„ç»˜åˆ¶
        }

        function renderWires(eOn, gOn) {
            ctx.clearRect(0, 0, 1200, 850);
            conns.forEach(c => {
                const p1 = getCtr(c.from), p2 = getCtr(c.to);
                ctx.beginPath(); ctx.lineWidth = c.type === 'wire' ? 4 : 10;  //ä»è¿æ¥ä¸­å–æ•°æ®ï¼Œæ§åˆ¶å®½åº¦ã€‚
                ctx.strokeStyle = c.type === 'wire' ? (eOn ? "#ff4757" : "#95a5a6") : (gOn ? "#3498db" : "#bdc3c7");  //æ ¹æ®ç±»å‹å’Œè¿é€šçŠ¶æ€è®¾å®šé¢œè‰²
                const midX = (p1.x + p2.x) / 2;  //åˆ†æˆ3æ®µ
                ctx.moveTo(p1.x, p1.y); ctx.lineTo(midX, p1.y); ctx.lineTo(midX, p2.y); ctx.lineTo(p2.x, p2.y);
                ctx.stroke();
                ctx.fillStyle = ctx.strokeStyle;
                ctx.beginPath(); ctx.arc(p1.x, p1.y, 6, 0, Math.PI * 2); ctx.fill();   //ç»˜åˆ¶æ¥çº¿æŸ±ã€‚
                ctx.beginPath(); ctx.arc(p2.x, p2.y, 6, 0, Math.PI * 2); ctx.fill();
            });
        }

        function getCtr(id) {
            const el = document.getElementById(id), b = document.getElementById('bench').getBoundingClientRect(), r = el.getBoundingClientRect();
            return { x: r.left - 4 - b.left + r.width / 2, y: r.top - 5 - b.top + r.height / 2 };
        }

        // --- æ‹–æ‹½é€»è¾‘ (æ”¯æŒç»„ä»¶å’Œæ§åˆ¶å°) ---
        function makeDraggable(el) {
            // å¦‚æœæ˜¯æ§åˆ¶å°ï¼Œåªæœ‰headerèƒ½è§¦å‘æ‹–æ‹½
            // const handle = el.classList.contains('ui-draggable') ? el.querySelector('.ui-header') : el;
            const handle = el;
            handle.onmousedown = (e) => {
                if (e.target.classList.contains('term') || e.target.type === 'range' || e.target.tagName === 'BUTTON') return;
                let mx = e.clientX, my = e.clientY;
                document.onmousemove = (ev) => {
                    el.style.top = (el.offsetTop - (my - ev.clientY)) + "px";
                    el.style.left = (el.offsetLeft - (mx - ev.clientX)) + "px";
                    mx = ev.clientX; my = ev.clientY; update();
                };
                document.onmouseup = () => document.onmousemove = null;
            };
        }

        const steps = [
            { msg: "1. ç”µæº(+) -> å¼€å…³", act: () => conns.push({ from: 't_p_p', to: 't_s_i', type: 'wire' }) },
            { msg: "2. å¼€å…³ -> å˜é€å™¨(+)", act: () => conns.push({ from: 't_s_o', to: 't_t_p', type: 'wire' }) },
            { msg: "3. å˜é€å™¨(-) -> ç”µæµè¡¨(+)", act: () => conns.push({ from: 't_t_n', to: 't_a_p', type: 'wire' }) },
            { msg: "4. ç”µæµè¡¨(-) -> ç”µæº(-)", act: () => conns.push({ from: 't_a_n', to: 't_p_n', type: 'wire' }) },
            { msg: "5. æ°”æº -> è°ƒèŠ‚é˜€", act: () => conns.push({ from: 't_gas', to: 't_r_i', type: 'pipe' }) },
            { msg: "6. è°ƒèŠ‚é˜€ -> å˜é€å™¨", act: () => conns.push({ from: 't_r_o', to: 't_t_g', type: 'pipe' }) },
            { msg: "7. è°ƒèŠ‚é˜€ -> å‹åŠ›è¡¨", act: () => conns.push({ from: 't_r_o', to: 't_g_i', type: 'pipe' }) }
        ];
        //å»¶æ—¶å®Œæ•´çš„æ“ä½œæ­¥éª¤
        function nextWireStep() {
            if (wireIdx < steps.length) {
                steps[wireIdx].act(); pushHistory('conn', null);
                document.getElementById('topInfo').innerText = steps[wireIdx].msg;
                wireIdx++; update();
            }
        }

        let fPoint = 0;
        function manualFivePoint() {
            const pts = [0, 0.25, 0.5, 0.75, 1.0];
            document.getElementById('pS').value = pts[fPoint];
            document.getElementById('topInfo').innerHTML = `5ç‚¹æ­¥è¿›: <span style="color:#f1c40f">${pts[fPoint].toFixed(2)} MPa</span> | ç†è®º: ${(pts[fPoint] * 16 + 4).toFixed(2)} mA`;
            update(); fPoint = (fPoint + 1) % 5;
        }

        // åˆå§‹åŒ–è¿è¡Œ
        document.querySelectorAll('.comp, .ui-draggable').forEach(comp => {
            if (!comp.classList.contains('ui-draggable')) {
                const h = Math.floor(Math.random() * 360), s = 25, l = 92;
                comp.style.backgroundColor = `hsl(${h}, ${s}%, ${l}%)`;
            }
            makeDraggable(comp);
        });

        drawDetailedGauge('f_am', 20); drawDetailedGauge('f_pg', 1);
        update();
    </script>
</body>

</html>