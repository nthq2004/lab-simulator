<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>机舱监测报警系统模拟器 - 逻辑联动版</title>
    <style>
        body { margin: 0; background: #2c3e50; font-family: "Microsoft YaHei", sans-serif; overflow: hidden; user-select: none; }
        #sim-container { position: relative; width: 100vw; height: 100vh; }
        canvas { display: block; background: #fdfdfd; }
        @media screen and (orientation: portrait) and (max-width: 1024px) {
    #main-wrapper {
        width: 100vh; height: 100vw;
        position: absolute; top: 0; left: 100vw;
        transform: rotate(90deg); transform-origin: top left;
    }
}
        #control-panel {
            position: absolute; top: 10px; left: 1150px; width: 340px;
            background: rgba(245, 245, 245, 0.98); border: 2px solid #7f8c8d;
            border-radius: 8px; padding: 12px; z-index: 1000; cursor: move;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .panel-title { font-weight: bold; text-align: center; border-bottom: 2px solid #3498db; margin-bottom: 10px; padding-bottom: 5px; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 10px; }
        button { padding: 6px; cursor: pointer; font-size: 12px; border: 1px solid #bdc3c7; border-radius: 4px; background: #fff; transition: 0.2s; }
        button:hover { background: #ecf0f1; }
        button.active-fault { background: #e74c3c; color: white; border-color: #c0392b; font-weight: bold; }
        button.tool { background: #3498db; color: white; border: none; }
        
        .ui-element { position: absolute; pointer-events: auto; }
        .v-slider { transform: rotate(-90deg); width: 100px; cursor: pointer; }
    </style>
</head>
<body>

<div id="sim-container">
    <div id="control-panel" onmousedown="dragPanel(event, this)">
        <div class="panel-title">机舱系统控制与联动仿真</div>
        <div class="btn-grid">
            <button class="tool" onclick="autoLinkCAN()">CAN总线连接</button>
            <button class="tool" onclick="autoLinkPT()">PT100连接</button>
            <button class="tool" onclick="autoLinkLamp()">报警灯连接</button>
            <button class="tool" onclick="autoLinkOil()">液位开关连接</button>
            <button class="tool" onclick="autoLinkValve()">阀门连接</button>
            <button onclick="undo()">撤销操作</button>
            <button style="grid-column: span 2; background: #95a5a6; color: #fff;" onclick="resetWires()">接线复位</button>
        </div>
        <div class="btn-grid" id="fault-btns">
            <button onclick="setFault(1)" id="f1">故障1</button>
            <button onclick="setFault(2)" id="f2">故障2</button>
            <button onclick="setFault(3)" id="f3">故障3</button>
            <button onclick="setFault(4)" id="f4">故障4</button>
            <button onclick="setFault(5)" id="f5">故障5</button>
            <button onclick="setFault(6)" id="f6">故障6</button>
            <button style="grid-column: span 2; background: #27ae60; color: #fff;" onclick="resetFault()">故障复位</button>
        </div>
    </div>
    <canvas id="mainCanvas"></canvas>
</div>

<script>
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let comps = [], wires = [];
let selectedPort = null, hoverPort = null, draggingComp = null, dragOffset = {x:0, y:0};
let activeFault = 0, tick = 0, busConnected = false;

const state = {
    waterTemp: 25, 
    oilLevel: 60, // 初始液位
    do1_manual: false, // 手动DO控制
    aoMode: 'auto', 
    aoManual: 12
};

class Port {
    constructor(parent, dx, dy, id, color = "#2c3e50") {
        this.parent = parent; this.dx = dx; this.dy = dy; this.id = id; this.color = color;
    }
    get x() { return this.parent.x + this.dx; }
    get y() { return this.parent.y + this.dy; }
}

class Component {
    constructor(x, y, w, h, label, type) {
        this.x = x; this.y = y; this.w = w; this.h = h; this.label = label; this.type = type;
        this.ports = [];
        if(this.type === 'water' || this.type === 'tank') this.createSlider();
    }
    createSlider() {
        const s = document.createElement('input');
        s.type = 'range'; s.className = 'v-slider ui-element';
        s.min = 0; s.max = 100;
        s.value = this.type === 'water' ? 25 : 60; // 初始同步状态
        s.oninput = (e) => {
            // 液位逻辑调整：向上滑（值增大）液位升高
            if(this.type === 'water') state.waterTemp = parseInt(e.target.value);
            else state.oilLevel = parseInt(e.target.value); 
        };
        document.getElementById('sim-container').appendChild(s);
        this.slider = s;
    }
    draw() {
        ctx.save();
        ctx.fillStyle = this.type === 'screen' ? '#ffffff' : '#ecf0f1';
        ctx.strokeStyle = '#34495e'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.roundRect(this.x, this.y, this.w, this.h, 4); ctx.fill(); ctx.stroke();
        ctx.fillStyle = '#2c3e50'; ctx.font = 'bold 12px Arial'; ctx.textAlign = 'center';
        ctx.fillText(this.label, this.x + this.w/2, this.y - 10);
        this.drawLogic();
        this.drawPorts();
        if(this.slider) {
            this.slider.style.left = (this.x - 70) + 'px';
            this.slider.style.top = (this.y + this.h - 55) + 'px'; // 底部对齐
        }
        ctx.restore();
    }
    drawLogic() {
        ctx.lineWidth = 1; ctx.strokeStyle = '#95a5a6';
        if(this.type === 'dpu') {
            ctx.strokeRect(this.x+10, this.y+5, this.w-20, 25); ctx.fillText("通信接口", this.x+this.w/2, this.y+22);
            if(this.label === 'DPU1') {
                ctx.strokeRect(this.x+5, this.y+40, 40, 30); ctx.fillText("DI", this.x+25, this.y+60);
                ctx.strokeRect(this.x+10, this.y+this.h-35, this.w-20, 30); ctx.fillText("AI接口", this.x+this.w/2, this.y+this.h-15);
            } else {
                ctx.strokeRect(this.x+5, this.y+40, 40, 30); ctx.fillText("AO", this.x+25, this.y+60);
                ctx.strokeRect(this.x+10, this.y+this.h-35, this.w-20, 30); ctx.fillText("DO接口", this.x+this.w/2, this.y+this.h-15);
            }
        }
        if(this.type === 'host') {
            ctx.strokeRect(this.x+10, this.y+5, this.w-20, 25); ctx.fillText("通信接口", this.x+this.w/2, this.y+22);
        }
        if(this.type === 'tank') {
            ctx.fillStyle = '#3498db'; let fh = (state.oilLevel/100)*(this.h-10);
            ctx.fillRect(this.x+5, this.y+this.h-5-fh, this.w-10, fh);
            ctx.strokeStyle = 'red'; ctx.beginPath(); ctx.setLineDash([5, 3]);
            ctx.moveTo(this.x, this.y+this.h*0.75); ctx.lineTo(this.x+this.w, this.y+this.h*0.75); ctx.stroke();
            ctx.setLineDash([]);
        }
        if(this.type === 'sw') {
            ctx.strokeRect(this.x+5, this.y+5, this.w-10, this.h-10);
            ctx.beginPath(); ctx.moveTo(this.x+10, this.y+20);
            state.oilLevel < 25 ? ctx.lineTo(this.x+30, this.y+20) : ctx.lineTo(this.x+25, this.y+10);
            ctx.stroke();
        }
        if(this.type === 'valve') {
            let cur = getAOVal(); let p = cur > 0 ? Math.round(((cur-4)/16)*100) : 0;
            ctx.fillStyle = "#e67e22"; ctx.font = "bold 15px Arial"; ctx.fillText(p+"%", this.x+this.w/2, this.y+this.h/2+10);
            ctx.font = "10px Arial"; ctx.fillText(cur.toFixed(2)+"mA", this.x+this.w/2, this.y+this.h/2-10);
        }
        if(this.type === 'lamp') {
            ctx.beginPath(); ctx.arc(this.x+this.w/2, this.y+this.h/2+5, 12, 0, Math.PI*2); ctx.stroke();
            if(checkLamp() && (tick % 40 < 20)) { ctx.fillStyle = 'red'; ctx.fill(); }
        }
        if(this.type === 'screen') this.drawHMI();
    }
    drawHMI() {
        if(!isLinked("host_p", "scr_p")) return;
        ctx.fillStyle = "#000"; ctx.textAlign = "left"; ctx.font = "bold 13px Arial";
        const d1Ok = checkComm(dpu1), d2Ok = checkComm(dpu2);
        
        // 左屏
        let oilMsg = "液位正常";
        if(!d1Ok || !isLinked("sw1", "d1di1") || !isLinked("sw2", "d1di2")) oilMsg = "液位---";
        else if(state.oilLevel < 25) oilMsg = "油柜液位低";
        ctx.fillStyle = oilMsg.includes("低") ? "red" : "black"; 
        ctx.fillText(oilMsg, this.x+20, this.y+40);

        const ai = getAIVal();
        ctx.fillStyle = ai.err ? "red" : "black"; 
        ctx.fillText(ai.l1, this.x+20, this.y+85); 
        ctx.fillText(ai.l2, this.x+20, this.y+110);
        ctx.fillStyle = d1Ok ? "green" : "red"; 
        ctx.fillText(d1Ok?"DPU1通信正常":"报警: DPU1通信故障", this.x+20, this.y+this.h-25);
        
        // 右屏
        ctx.fillStyle = "black"; ctx.fillText("DO1：", this.x+this.w/2+20, this.y+40);
        updateHMIGui(this);
        ctx.fillStyle = d2Ok ? "green" : "red"; 
        ctx.fillText(d2Ok?"DPU2通信正常":"报警: DPU2通信故障", this.x+this.w/2+20, this.y+this.h-25);
    }
    drawPorts() {
        this.ports.forEach(p => {
            ctx.beginPath(); ctx.arc(p.x, p.y, (hoverPort===p||selectedPort===p)?7:5, 0, Math.PI*2);
            ctx.fillStyle = p.color; ctx.fill();
            ctx.strokeStyle = "#fff"; ctx.lineWidth = 1; ctx.stroke();
        });
    }
}

/** 逻辑判定 **/
function isLinked(id1, id2) {
    return wires.some(w => (w[0].id === id1 && w[1].id === id2) || (w[1].id === id1 && w[0].id === id2));
}

function checkComm(dpu) {
    if(activeFault === 4) return false;
    if(dpu.label === 'DPU1') {
        if(activeFault === 5) return false;
        const canOk = (isLinked("d1b1","h00_d1") && isLinked("d1b2","h00_d2")) || (isLinked("d1b3","h10_d1") && isLinked("d1b4","h10_d2"));
        return canOk && ((isLinked("hb1","h02_d1") && isLinked("hb2","h02_d2")) || (isLinked("hb3","h12_d1") && isLinked("hb4","h12_d2")));
    }
    return busConnected;
}

function getAIVal() {
    if(activeFault === 3) return {l1: "AI通道1电流 0mA", l2: "断线或通道损坏", err: true};
    if(!checkComm(dpu1)) return {l1: "AI通道1电流 ---mA", l2: "水温 ---度", err: false};
    if(activeFault === 1) return {l1: "AI通道1电流 21.6mA", l2: "传感器断线", err: true};
    if(activeFault === 2) return {l1: "AI通道1电流 3.6mA", l2: "传感器短路", err: true};
    const ptOk = isLinked("pt1", "tr1") && isLinked("pt2", "tr2") && isLinked("pt2", "tr3");
    const aiOk = isLinked("tr_u1", "d1ai1") && isLinked("tr_u2", "d1ai2");
    if(ptOk && aiOk) {
        let mA = 4 + (state.waterTemp/100)*16;
        return {l1: `AI通道1电流 ${mA.toFixed(1)}mA`, l2: `水温 ${state.waterTemp}度`, err: (state.waterTemp > 90)};
    }
    return {l1: "AI通道1电流 ---mA", l2: "水温 ---度", err: false};
}

function checkLamp() {
    // 联动逻辑核心：
    const tempAlarm = state.waterTemp > 90;
    const oilAlarm = state.oilLevel < 25 && isLinked("sw1", "d1di1") && isLinked("sw2", "d1di2");
    // 如果满足任一联动条件，且通信正常，则DO1强制接通
    const doActive = (tempAlarm || oilAlarm || state.do1_manual) && checkComm(dpu2);
    
    if(activeFault === 6 || !doActive) return false;
    // 物理连线检查
    return isLinked("d2do1", "ry1") && isLinked("d2do2", "ry2") && isLinked("ry3", "l1") && isLinked("ry4", "l2");
}

function getAOVal() {
    if(!checkComm(dpu2) || !isLinked("d2ao1", "v1") || !isLinked("d2ao2", "v2")) return 0;
    return state.aoMode === 'auto' ? (4 + (state.waterTemp/100)*16) : state.aoManual;
}

/** 组件初始化 **/
function init() {
    for(let r=0; r<2; r++) {
        let y = 50 + r*70;
        let rl = new Component(50, y, 20, 50, "120Ω", "res");
        rl.ports = [new Port(rl,10,0,`r${r}u`), new Port(rl,10,50,`r${r}d`)];
        let rr = new Component(1100, y, 20, 50, "120Ω", "res");
        rr.ports = [new Port(rr,10,0,`rr${r}u`), new Port(rr,10,50,`rr${r}d`)];
        comps.push(rl, rr);
        for(let i=0; i<3; i++) {
            let h = new Component(280+i*270+r*100, y-5, 80, 60, "CAN接口", "hub");
            h.ports = [new Port(h,0,15,`h${r}${i}_l1`), new Port(h,0,45,`h${r}${i}_l2`),
                       new Port(h,80,15,`h${r}${i}_r1`), new Port(h,80,45,`h${r}${i}_r2`),
                       new Port(h,25,60,`h${r}${i}_d1`), new Port(h,55,60,`h${r}${i}_d2`)];
            comps.push(h);
        }
    }
    window.dpu1 = new Component(220, 260, 160, 180, "DPU1", "dpu");
    dpu1.ports = [new Port(dpu1,20,0,"d1b1"), new Port(dpu1,40,0,"d1b2"), new Port(dpu1,120,0,"d1b3"), new Port(dpu1,140,0,"d1b4"),
                  new Port(dpu1,0,55,"d1di1","red"), new Port(dpu1,0,75,"d1di2"),
                  new Port(dpu1,20,180,"d1ai1","red"), new Port(dpu1,40,180,"d1ai2")];
    window.dpu2 = new Component(560, 260, 160, 180, "DPU2", "dpu");
    dpu2.ports = [new Port(dpu2,20,0,"d2b1"), new Port(dpu2,40,0,"d2b2"), new Port(dpu2,120,0,"d2b3"), new Port(dpu2,140,0,"d2b4"),
                  new Port(dpu2,0,55,"d2ao1","red"), new Port(dpu2,0,75,"d2ao2"),
                  new Port(dpu2,20,180,"d2do1","red"), new Port(dpu2,40,180,"d2do2"),
                  new Port(dpu2,120,180,"d2do3","red"), new Port(dpu2,140,180,"d2do4")];
    window.host = new Component(920, 260, 160, 100, "主控板", "host");
    host.ports = [new Port(host,20,0,"hb1"), new Port(host,40,0,"hb2"), new Port(host,120,0,"hb3"), new Port(host,140,0,"hb4"), new Port(host,80,100,"host_p")];
    window.scr = new Component(750, 450, 520, 280, "显示面板", "screen");
    scr.ports = [new Port(scr, 260, 0, "scr_p")];
    window.tank = new Component(30, 260, 100, 140, "油柜", "tank");
    window.oilSw = new Component(90, 365, 40, 40, "液位开关", "sw");
    oilSw.ports = [new Port(oilSw,40,10,"sw1"), new Port(oilSw,40,30,"sw2")];
    window.trans = new Component(220, 480, 120, 80, "变送器", "trans");
    trans.ports = [new Port(trans,30,0,"tr_u1","red"), new Port(trans,90,0,"tr_u2"),
                   new Port(trans,20,80,"tr1"), new Port(trans,60,80,"tr2"), new Port(trans,100,80,"tr3")];
    window.pt = new Component(250, 600, 60, 40, "PT100", "pt");
    pt.ports = [new Port(pt,0,20,"pt1"), new Port(pt,60,20,"pt2")];
    window.water = new Component(230, 680, 100, 70, "水槽", "water");
    window.valve = new Component(430, 290, 80, 100, "调节阀", "valve");
    valve.ports = [new Port(valve, 80, 30, "v1"), new Port(valve, 80, 70, "v2")];
    window.relay = new Component(535, 490, 90, 70, "继电器板", "relay");
    relay.ports = [new Port(relay,20,0,"ry1","red"), new Port(relay,70,0,"ry2"),
                   new Port(relay,20,70,"ry3","red"), new Port(relay,70,70,"ry4")];
    window.lamp = new Component(555, 600, 50, 50, "报警灯", "lamp");
    lamp.ports = [new Port(lamp,10,0,"l1"), new Port(lamp,40,0,"l2")];
    comps.push(dpu1, dpu2, host, scr, tank, oilSw, trans, pt, water, valve, relay, lamp);
}

/** 联动控制 UI **/
function updateHMIGui(scr) {
    let b = document.getElementById('do-b');
    if(!b) { b=document.createElement('button'); b.id='do-b'; b.className='ui-element'; b.onclick=()=>state.do1_manual=!state.do1_manual; document.getElementById('sim-container').appendChild(b); }
    
    // 联动逻辑状态
    const isAutoActive = (state.waterTemp > 90) || (state.oilLevel < 25 && isLinked("sw1", "d1di1"));
    b.style.left=(scr.x+scr.w/2+70)+'px'; b.style.top=(scr.y+25)+'px'; 
    b.innerText = (state.do1_manual || isAutoActive) ? "ON" : "OFF";
    b.style.background = (state.do1_manual || isAutoActive) ? "#e74c3c" : "#bdc3c7";
    b.style.boxShadow = isAutoActive ? "0 0 10px red" : "none";

    let a = document.getElementById('ao-g');
    if(!a) { a=document.createElement('div'); a.id='ao-g'; a.className='ui-element'; a.innerHTML=`<select id="aom" style="font-size:10px;"><option value="auto">自动</option><option value="man">手动</option></select><input type="range" id="aov" min="4" max="20" step="0.1" style="width:70px">`; document.getElementById('sim-container').appendChild(a); document.getElementById('aom').onchange=(e)=>state.aoMode=e.target.value; document.getElementById('aov').oninput=(e)=>state.aoManual=parseFloat(e.target.value); }
    a.style.left=(scr.x+scr.w/2+20)+'px'; a.style.top=(scr.y+65)+'px'; document.getElementById('aov').style.display=state.aoMode==='man'?'inline-block':'none';
}

/** 自动化功能 **/
function autoLinkCAN() { busConnected = true; wires = []; const find = id => { for(let c of comps) for(let p of c.ports) if(p.id===id) return p; }; const l = (a, b) => { let p1=find(a), p2=find(b); if(p1&&p2) wires.push([p1,p2]); }; for(let r=0; r<2; r++){ l(`r${r}u`,`h${r}0_l1`); l(`r${r}d`,`h${r}0_l2`); l(`h${r}0_r1`,`h${r}1_l1`); l(`h${r}0_r2`,`h${r}1_l2`); l(`h${r}1_r1`,`h${r}2_l1`); l(`h${r}1_r2`,`h${r}2_l2`); l(`h${r}2_r1`,`rr${r}u`); l(`h${r}2_r2`,`rr${r}d`); } l("d1b1","h00_d1"); l("d1b2","h00_d2"); l("d1b3","h10_d1"); l("d1b4","h10_d2"); l("d2b1","h01_d1"); l("d2b2","h01_d2"); l("d2b3","h11_d1"); l("d2b4","h11_d2"); l("hb1","h02_d1"); l("hb2","h02_d2"); l("hb3","h12_d1"); l("hb4","h12_d2"); l("host_p", "scr_p"); }
function autoLinkPT() { const l=(a,b)=>{let p1=findPortById(a),p2=findPortById(b);if(p1&&p2)wires.push([p1,p2]);}; l("pt1","tr1"); l("pt2","tr2"); l("pt2","tr3"); l("tr_u1","d1ai1"); l("tr_u2","d1ai2"); }
function autoLinkLamp() { const l=(a,b)=>{let p1=findPortById(a),p2=findPortById(b);if(p1&&p2)wires.push([p1,p2]);}; l("d2do1","ry1"); l("d2do2","ry2"); l("ry3","l1"); l("ry4","l2"); }
function autoLinkOil() { const l=(a,b)=>{let p1=findPortById(a),p2=findPortById(b);if(p1&&p2)wires.push([p1,p2]);}; l("sw1","d1di1"); l("sw2","d1di2"); }
function autoLinkValve() { const l=(a,b)=>{let p1=findPortById(a),p2=findPortById(b);if(p1&&p2)wires.push([p1,p2]);}; l("d2ao1","v1"); l("d2ao2","v2"); }
function findPortById(id) { for(let c of comps) for(let p of c.ports) if(p.id===id) return p; }

function setFault(n) { if(activeFault!==0) return; activeFault=n; document.getElementById('f'+n).classList.add('active-fault'); }
function resetFault() { activeFault=0; document.querySelectorAll('#fault-btns button').forEach(b=>b.classList.remove('active-fault')); }
function resetWires() { wires = []; busConnected = false; }
function undo() { wires.pop(); }
function dragPanel(e, el) { if(e.target.tagName==='BUTTON' || e.target.tagName==='SELECT') return; let x=e.clientX-el.offsetLeft, y=e.clientY-el.offsetTop; document.onmousemove=(ev)=>{el.style.left=(ev.clientX-x)+'px'; el.style.top=(ev.clientY-y)+'px';}; document.onmouseup=()=>{document.onmousemove=null;}; }

canvas.onmousedown = (e) => {
    let p = findPortAt(e.clientX, e.clientY);
    if(p) { if(!selectedPort) selectedPort=p; else { if(selectedPort!==p) wires.push([selectedPort,p]); selectedPort=null; }
    } else { draggingComp = comps.find(c => e.clientX>c.x && e.clientX<c.x+c.w && e.clientY>c.y && e.clientY<c.y+c.h);
        if(draggingComp) dragOffset={x:e.clientX-draggingComp.x, y:e.clientY-draggingComp.y};
    }
};
canvas.onmousemove=(e)=>{ hoverPort=findPortAt(e.clientX, e.clientY); if(draggingComp){ draggingComp.x=e.clientX-dragOffset.x; draggingComp.y=e.clientY-dragOffset.y; if(draggingComp===tank){ oilSw.x=tank.x+60; oilSw.y=tank.y+105; } } };
canvas.onmouseup=()=>draggingComp=null;
function findPortAt(x,y){ for(let c of comps) for(let p of c.ports) if(Math.hypot(p.x-x, p.y-y)<10) return p; return null; }

init();
function loop() {
    tick++; ctx.clearRect(0,0,canvas.width,canvas.height);
    wires.forEach(w => { ctx.strokeStyle="#3498db"; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(w[0].x,w[0].y); ctx.lineTo(w[1].x,w[1].y); ctx.stroke(); });
    comps.forEach(c => c.draw());
    requestAnimationFrame(loop);
}
loop();
</script>
</body>

</html>
